## Функция обновления и автообновления приложения.

Используется плагин Capacitor от Capgo - https://capgo.app/docs/plugin/self-hosted/manual-update/

Назначение - обновление веб-клиента которое исполняется внутри ВебВью, без обновления через АппМаркет самого приложения (нативной обертки)

доступно 2 варианта обновления: вручную и автоматически. 

Функция реализована на отдельной странице.

### Настройки

Сначала в специальной форме настроек указывается УРЛ нашего сервера, на котором хранятся различные версии приложения. Текущая версия приложения задана в package.json. 
Задаем только УРЛ. путь к папке с обновлениями относительно корня сервера - жестко задан в приложении.
Запросы серверу должны отправляться по протоколу HTTPS. (на сервере надо настроить протокол и нормальный полноценный сертификат для сайта)

### Пакеты с обновлениями

Согласно мануалу - командой - npx @capgo/cli bundle zip

Имя которое создается - оставляем как есть.

Обновления кладем в папку на сервере со всеми обновлениями, в подпапку с именем версии

### Ручное обновление:

Чтоб работало автообновление надо в конфиге капаситора включить опцию автообновлений (autoUpdate)

но урл к методу проверки обновлений можно не задавать - потом укажем динамически при работе программы (updateUrl) и allowModifyUrl

По кнопке “Check For Updates” вызывается серверный метод (самописный), который сканирует все папки с версиями (имена) и отдает их на клиент в порядке от самой новой к самой старой. 

На клиенте выводится текущая версия клиента и последняя доступная версия на сервере, и ниже - кнопки с названиями версий с вариантами скачивания: с помощью плагина или напрямую через URL к zip  версии на сервере. 
* Если нажимается кнопка скачивания версии с помощью плагина, то после ее загрузки появляется модальное окно с кнопками: скачать обновление сейчас или при следующем открытии приложения. (для проверки разных вариантов обновления) 
* Если выбрано “обновить сейчас”, то вызывается функция CapacitorUpdater.set(dataUpd), где dataUpd хранит название версии и ссылку на нее. После этого вызывается функция перезагрузки приложения. 
* Если выбрано обновить потом, то вызывается функция CapacitorUpdater.next(dataUpd), которая устанавливает указанный пакет, который будет использоваться при перезагрузке приложения. 

При каждом открытии приложения вызывается функция CapacitorUpdater.notifyAppReady(), которая проверяет что текущая установленная версия работает и не надо откатываться к предыдущей.

### Автоматически: 

На форме настроек указывается чекбокс: обновлять ли приложение автоматически (по умолчанию при открытии приложения - нет). 

По чеку - вызывается функция CapacitorUpdater.setUpdateUrl({ url: url }), где url - ссылка на серверный метод. 


Плагин сам будет выполнять POST-вызов к вашему API каждый раз при открытии приложения. API сервера должен ответить в JSON плагину Capacitor-Updater в формате 

{
"version": "1.2.3",
"url": "https://myserver.com/app/updates/my-new-app-2.0.0.zip"
}.

https://capgo.app/docs/plugin/cloud-mode/hybrid-update/

В режиме автоматического обновления сервер получает все доступные версии и возвращает последнюю(более новую) не установленную. Если в возвращаемом JSON присутствует URL версии, плагин начинает процесс загрузки. 

При получении новой версии вылазит модальное окно - что приложение готово для обновления

https://capgo.app/docs/plugin/cloud-mode/hybrid-update/

Также присутствует функция сбора статистики о процессах обновления. Вызывается функция CapacitorUpdater.setStatsUrl с ссылкой на серверный метод. Плагин будет выполнять POST-вызов со статистикой приложения, а сервер записывать ее в txt-документ с указанием текущего времени и даты. Это удобно для отладки.

https://capgo.app/docs/plugin/self-hosted/handling-stats/


